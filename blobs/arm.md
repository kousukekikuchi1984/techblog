# 普段のコーディング時に意識したい CPU の特性

## Introduction

社長 > おーい、お前、そろそろ技術ブログ書いておいて。書かないと減給な。

```
メロスは激怒した。必ず、かの邪智暴虐の社長を除かなければならぬと決意した。メロスには何を書けば良いのかがわからぬ。メロスは、村のエンジニアである。コードを書き、コンピュータと遊んで暮して来た。けれども減給に対しては、人一倍に敏感であった。
```

ということがあったかどうかは定かではありませんが、基本私はチキンです。どれだけチキンかというと "骨なしチキンのお客様"とコンビニで言われたら、"Nobody call me chicken!" と言うくらいのチキンです。せめてものの社長への抵抗として、実務的にはあまり役にたたない知識を techblog として記したいと思います。
 さて、私は正式にコンピューターサイエンスという学問を学んだことがありません。日頃から業務に当たる上で、コンピューターサイエンスを学んでおかないといけない適切な設計はできないな、と思うようになり、コンピューターサイエンスを学んでいる最中です。

 中でも CPUの構造がアプリケーションレイヤーに出てくる点が今まで経験したことがないが、物理レベルのアーキテクチャの設計思想がアプリケーションレイヤーに及ぶことがありうると聞いて衝撃を受けたことがあります。これがありうる例となぜそうなるのかを話したいと思います。


## CPU のキャッシュヒット率

### 問題 1.

突然ですが、この二つのコード配列のアクセスが違いますが、どちらも同じ速度で動くと思いますか？

```rust
fn main() {
    let mut array1 = vec![vec![1; 10000]; 10000];
    let array2 = vec![vec![2; 10000]; 10000];
    for j in 0..10000 {
        for i in 0..10000 {
            array1[j][i] = array2[j][i];
        }
    }
}
```

```rust
fn main() {
    let mut array1 = vec![vec![1; 10000]; 10000];
    let array2 = vec![vec![2; 10000]; 10000];
    for i in 0..10000 {
        for j in 0..10000 {
            array1[j][i] = array2[j][i];
        }
    }
}
```

これらのコードは for 内で配列を array2 から array1 に値を移行しています。
これらの違いは配列へのアクセスの違いです。具体的には、二重配列の外側から最初にアップデートするのか、それとも内側からアップデートするかの違いです。
検証のために実際に動かしてみましょう。
便宜上、上記のコードのうち、上のものを former, 下のものを latter とします。

``` sh
> time ./target/debug/former
./target/debug/fast  9.25s user 0.36s system 99% cpu 9.620 total

```


```sh
> time ./target/debug/slow
./target/debug/slow  32.37s user 0.49s system 99% cpu 32.865 total
```

と、結果をみると3倍以上差が出ていることに驚くと思います。これはなぜ発生するのでしょうか？ これは実は CPU のキャッシュに由来しています。

注. 今回用いる CPU は Apple Silicon の M2 Pro ですが、別の CPU でも発生しえます。

### CPU の構造のおさらい

- ここには ARU とレジスタを説明
- メモリは遅すぎるので、手元の キャッシュを使う

### CPU のキャッシュの特性

- LRU
- 新しくロードする時にはその周辺のデータを load する（このあたりはもっと調べる必要がある）
- 結果、配列の内側のみキャッシュされるので、配列の外側を更新しようとするとメモリから逐一読み込まなければならないので、遅くなる



## CPU の計算回数

### 問題2.

- あれhttps://twitter.com/mathclimber/status/1670363518061936641?s=20
- エンジニアがざわざわ
  - 遅い、むしろ早いとか
- 実際早いのだろうか。



